@using PizzaOrderApp.Models
@using PizzaOrderApp.Services
@inject OrderService OrderService
@implements IDisposable // KaynaklarÄ± serbest bÄ±rakmak iÃ§in IDisposable arayÃ¼zÃ¼nÃ¼ uyguluyoruz

<div class="card shadow-sm order-summary-card">
    <div class="card-header bg-warning text-dark">
        <h5 class="mb-0">ğŸ›’ SipariÅŸ Ã–zeti</h5>
    </div>
    <div class="card-body">
        
        @if (OrderService.CurrentOrder.SelectedPizza != null)
        {
            <h6>@OrderService.CurrentOrder.SelectedPizza.Name</h6>
            
            <ul class="list-unstyled small">
                <li>
                    <strong>Boyut:</strong> 
                    @OrderService.CurrentOrder.SelectedSize?.Name 
                    (@(OrderService.CurrentOrder.SelectedSize?.Multiplier.ToString("0.0"))x)
                </li>
                
                <li>
                    <strong>Ek Malzemeler:</strong> 
                    @if (OrderService.CurrentOrder.SelectedToppings.Any())
                    {
                        <span>@OrderService.CurrentOrder.SelectedToppings.Count adet (+@((OrderService.CurrentOrder.SelectedToppings.Count * 10).ToString("C2")) )</span>
                    }
                    else
                    {
                        <span>Yok</span>
                    }
                </li>
            </ul>
        }
        else
        {
            <p class="text-muted">LÃ¼tfen menÃ¼den bir pizza seÃ§imi yapÄ±n.</p>
        }
    </div>

    <div class="card-footer d-flex justify-content-between align-items-center bg-light">
        <span class="h5 mb-0">Toplam Tutar:</span>
        <span class="total-price h4 mb-0 text-success">
            @OrderService.CurrentOrder.TotalPrice.ToString("C2")
        </span>
    </div>

    <div class="p-3">
        <button class="btn btn-lg btn-success w-100" 
                @onclick="GoToCheckout"
                disabled="@(OrderService.CurrentOrder.SelectedPizza == null)">
            SipariÅŸi Tamamla (@OrderService.CurrentOrder.TotalPrice.ToString("C2"))
        </button>
    </div>
</div>

@code {
    @inject NavigationManager NavManager
    
    protected override void OnInitialized()
    {
        // 1. Abonelik: BileÅŸen baÅŸlatÄ±ldÄ±ÄŸÄ±nda, OrderService'teki olaylara abone ol.
        // Bu, OrderService.UpdateOrder() Ã§aÄŸrÄ±ldÄ±ÄŸÄ±nda bu bileÅŸenin NotifyStateChanged() metodunu Ã§alÄ±ÅŸtÄ±rÄ±r.
        OrderService.OnOrderStateChanged += OnOrderUpdated; 
    }

    // Olay Geri Ã‡aÄŸrÄ±mÄ±: OrderService durumu gÃ¼ncellediÄŸinde Ã§alÄ±ÅŸÄ±r.
    private void OnOrderUpdated()
    {
        // 2. ArayÃ¼z GÃ¼ncelleme: Durum deÄŸiÅŸtiÄŸinde Blazor'a arayÃ¼zÃ¼ yeniden Ã§izmesini sÃ¶yle.
        // Bu sayede TotalPrice anlÄ±k olarak gÃ¼ncellenir.
        StateHasChanged(); 
    }

    // Programatik YÃ¶nlendirme (Ders3: Navigation Manager)
    private void GoToCheckout()
    {
        NavManager.NavigateTo("/checkout");
    }

    // 3. Abonelikten Ã‡Ä±kma (Temizlik): BileÅŸen bellekten kaldÄ±rÄ±lÄ±rken kaynaklarÄ± serbest bÄ±rak. (Bellek sÄ±zÄ±ntÄ±sÄ±nÄ± Ã¶nler)
    public void Dispose()
    {
        OrderService.OnOrderStateChanged -= OnOrderUpdated;
    }
}