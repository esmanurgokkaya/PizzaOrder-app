@namespace PizzaOrderApp.Components
@inject OrderService OrderService
@inject NavigationManager NavManager

@* Bu bileşen: sipariş için teslimat bilgilerini toplar.
    - `EditForm` ile model bağlama ve validasyon yapar.
    - Geçerli sipariş `OrderService.CurrentOrder.CustomerInfo` üzerinden yönetilir.
    - OnValidSubmit başarılı olduğunda sipariş numarası oluşturulur ve onay sayfasına yönlendirilir. *@

<div class="card p-4 shadow-lg customer-form-card">
    <h4 class="mb-4">Teslimat Bilgileri</h4>
    @* Form: veri bağlama ve doğrulama (DataAnnotations) kullanılır. *@
    @if (isSubmitting)
    { <div class="alert alert-info">Siparişiniz işleniyor...</div> }

    <EditForm Model="@OrderService.CurrentOrder.CustomerInfo" OnValidSubmit="HandleValidSubmit">
        <DataAnnotationsValidator />

        <div class="mb-3">
            <label for="name" class="form-label">Ad Soyad</label>
            <InputText id="name" class="form-control" @bind-Value="OrderService.CurrentOrder.CustomerInfo.Name" />
            <ValidationMessage For="@(() => OrderService.CurrentOrder.CustomerInfo.Name)" />
        </div>
        <div class="mb-3">
            <label for="email" class="form-label">E-posta</label>
            <InputText id="email" type="email" class="form-control" @bind-Value="OrderService.CurrentOrder.CustomerInfo.Email" />
            <ValidationMessage For="@(() => OrderService.CurrentOrder.CustomerInfo.Email)" />
        </div>
        <div class="mb-3">
            <label for="address" class="form-label">Teslimat Adresi</label>
            <InputTextArea id="address" class="form-control" rows="3" @bind-Value="OrderService.CurrentOrder.CustomerInfo.Address" />
            <ValidationMessage For="@(() => OrderService.CurrentOrder.CustomerInfo.Address)" />
        </div>

        <button type="submit" class="btn btn-primary btn-lg w-100 mt-3" disabled="@isSubmitting">
            Siparişi Onayla ve Öde
        </button>
    </EditForm>
</div>

@code {
    private bool isSubmitting = false;

    private async Task HandleValidSubmit()
    {
        if (isSubmitting) return;
        isSubmitting = true;
        StateHasChanged(); 

        var orderNumber = $"PZ-{DateTime.Now.ToString("yyyyMMdd")}-{new Random().Next(1000, 9999)}";
        OrderService.CurrentOrder.OrderNumber = orderNumber;

        // Veritabanına kaydet
        Console.WriteLine("Sipariş veritabanına kaydediliyor...");
        bool success = await OrderService.PlaceCurrentOrderAsync();
        
        if (success)
        {
            Console.WriteLine("Sipariş başarıyla veritabanına kaydedildi!");
            await OrderService.SaveOrderToLocalStorageAsync();
            NavManager.NavigateTo($"/confirmation/{orderNumber}");
        }
        else
        {
            Console.WriteLine("Sipariş kaydedilemedi!");
            isSubmitting = false;
            StateHasChanged();
        }
    }
}